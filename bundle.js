(()=>{var Bt=Object.create;var Y=Object.defineProperty;var Wt=Object.getOwnPropertyDescriptor;var Jt=Object.getOwnPropertyNames;var Yt=Object.getPrototypeOf,Ft=Object.prototype.hasOwnProperty;var Zt=e=>Y(e,"__esModule",{value:!0});var Xt=(e,t)=>()=>(e&&(t=e(e=0)),t);var Qt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),eo=(e,t)=>{for(var o in t)Y(e,o,{get:t[o],enumerable:!0})},to=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Jt(t))!Ft.call(e,r)&&(o||r!=="default")&&Y(e,r,{get:()=>t[r],enumerable:!(n=Wt(t,r))||n.enumerable});return e},F=(e,t)=>to(Zt(Y(e!=null?Bt(Yt(e)):{},"default",!t&&e&&e.__esModule?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var q=Qt((Q,qe)=>{(function(e,t){typeof Q=="object"&&typeof qe<"u"?t(Q):typeof define=="function"&&define.amd?define(["exports"],t):(e=typeof globalThis<"u"?globalThis:e||self,t(e["fast-equals"]={}))})(Q,function(e){"use strict";var t=typeof WeakSet=="function",o=Object.keys;function n(a,d){return a===d||a!==a&&d!==d}function r(a){return a.constructor===Object||a.constructor==null}function s(a){return!!a&&typeof a.then=="function"}function c(a){return!!(a&&a.$$typeof)}function m(){var a=[];return{add:function(d){a.push(d)},has:function(d){return a.indexOf(d)!==-1}}}var T=function(a){return a?function(){return new WeakSet}:m}(t);function H(a){return function(E){var p=a||E;return function(h,f,u){u===void 0&&(u=T());var v=!!h&&typeof h=="object",w=!!f&&typeof f=="object";if(v||w){var W=v&&u.has(h),J=w&&u.has(f);if(W||J)return W&&J;v&&u.add(h),w&&u.add(f)}return p(h,f,u)}}}function Kt(a,d,E,p){var l=a.length;if(d.length!==l)return!1;for(;l-- >0;)if(!E(a[l],d[l],p))return!1;return!0}function _t(a,d,E,p){var l=a.size===d.size;if(l&&a.size){var h={};a.forEach(function(f,u){if(l){var v=!1,w=0;d.forEach(function(W,J){!v&&!h[w]&&(v=E(u,J,p)&&E(f,W,p),v&&(h[w]=!0)),w++}),l=v}})}return l}var Ut="_owner",Gt=Function.prototype.bind.call(Function.prototype.call,Object.prototype.hasOwnProperty);function Ce(a,d,E,p){var l=o(a),h=l.length;if(o(d).length!==h)return!1;if(h)for(var f=void 0;h-- >0;){if(f=l[h],f===Ut){var u=c(a),v=c(d);if((u||v)&&u!==v)return!1}if(!Gt(d,f)||!E(a[f],d[f],p))return!1}return!0}function Ht(a,d){return a.source===d.source&&a.global===d.global&&a.ignoreCase===d.ignoreCase&&a.multiline===d.multiline&&a.unicode===d.unicode&&a.sticky===d.sticky&&a.lastIndex===d.lastIndex}function Lt(a,d,E,p){var l=a.size===d.size;if(l&&a.size){var h={};a.forEach(function(f){if(l){var u=!1,v=0;d.forEach(function(w){!u&&!h[v]&&(u=E(f,w,p),u&&(h[v]=!0)),v++}),l=u}})}return l}var At=typeof Map=="function",zt=typeof Set=="function";function L(a){var d=typeof a=="function"?a(E):E;function E(p,l,h){if(p===l)return!0;if(p&&l&&typeof p=="object"&&typeof l=="object"){if(r(p)&&r(l))return Ce(p,l,d,h);var f=Array.isArray(p),u=Array.isArray(l);return f||u?f===u&&Kt(p,l,d,h):(f=p instanceof Date,u=l instanceof Date,f||u?f===u&&n(p.getTime(),l.getTime()):(f=p instanceof RegExp,u=l instanceof RegExp,f||u?f===u&&Ht(p,l):s(p)||s(l)?p===l:At&&(f=p instanceof Map,u=l instanceof Map,f||u)?f===u&&_t(p,l,d,h):zt&&(f=p instanceof Set,u=l instanceof Set,f||u)?f===u&&Lt(p,l,d,h):Ce(p,l,d,h)))}return p!==p&&l!==l}return E}var Vt=L(),qt=L(function(){return n}),Nt=L(H()),$t=L(H(n));e.circularDeepEqual=Nt,e.circularShallowEqual=$t,e.createCustomEqual=L,e.deepEqual=Vt,e.sameValueZeroEqual=n,e.shallowEqual=qt,Object.defineProperty(e,"__esModule",{value:!0})})});var wt={};eo(wt,{css:()=>xt});var xt,jt=Xt(()=>{xt=`.spinner{width:70px;text-align:center;position:absolute}.spinner .bounce1{-webkit-animation-delay:-.32s;animation-delay:-.32s}.spinner .bounce2{-webkit-animation-delay:-.16s;animation-delay:-.16s}.spinner>div{width:15px;height:15px;background-color:#fff;border-radius:100%;display:inline-block;-webkit-animation:sk-bouncedelay 1.4s infinite ease-in-out both;animation:sk-bouncedelay 1.4s infinite ease-in-out both}@-webkit-keyframes sk-bouncedelay{0%,80%,to{-webkit-transform:scale(0)}40%{-webkit-transform:scale(1)}}@keyframes sk-bouncedelay{0%,80%,to{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}#chat-container{visibility:hidden;position:fixed;z-index:1;bottom:50px;width:280px;margin:0 20px 10px}#chat-list{max-height:500px;overflow-y:auto;overflow-x:hidden;position:relative;direction:rtl;text-align:left;background-color:#0006;border-radius:5px 5px 0 0}.chat-item{display:block;background:none;padding:5px 10px;direction:ltr;font-size:13px;line-height:1.5rem;word-break:break-word;box-shadow:none}.chat-link{text-decoration:underline;color:#1cb8ff}.chat-link:visited{color:#364963}#chat-input{background-color:#0006;color:#fff;border-radius:0 0 5px 5px;margin-top:2px;margin-bottom:8px;font-size:13px}#chat-input::placeholder{color:#dadada}button{background-color:#444;color:#1a1a1a;display:inline-block;padding:5px 10px;margin-top:10px;font-size:16px;border-radius:4px;border:none;box-shadow:2px 3px 8px #00000059;width:90px;text-align:center;cursor:pointer}button:hover{background-color:#6a6a6a}button.primary{background-color:#5490df}button.primary:hover{background-color:#94baeb}button.secondary{background-color:#8483f6}button.secondary:hover{background-color:#cbcafb}button.cancel{background-color:#f14d59}button.cancel:hover{background-color:#f7949b}.popupTitle{text-align:center;margin-bottom:10px;color:#fff}.joinPop{pointer-events:auto;border-radius:10px;background-color:#222227;padding:15px;text-align:left;position:absolute;top:40%;left:50%;transform:translate(-50%,-60%);color:#fff;width:372px}.joinInput{margin-top:5px;width:100%;font-size:20px;border-radius:4px;box-sizing:border-box;padding:5px}#joinPassword{width:100%;font-size:20px;border-radius:4px;box-sizing:border-box;padding:5px}.joinBtn{width:100%}#hotbar{grid-template-columns:45% 10% 45%}#playbar{grid-template-columns:repeat(auto-fit,minmax(10px,1fr))}#multiplayerIcon{font-size:25px}.warning{color:#f14d59!important}.button-row{display:flex;justify-content:center;gap:20px}.button-row>button{width:100%}.slider:before{transition:.2s}.vector3 input[type=text]{padding:4px;border-radius:4px;font-size:10px;background-color:#bbb}#epVersion{background:linear-gradient(45deg,#0d9fc7,#c500ff);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-block}#epVersion:hover{cursor:pointer}.menuShortTabNew{width:20%}
`;document.head.appendChild(document.createElement("style")).appendChild(document.createTextNode(xt))});var dn=typeof process!="undefined"&&process.release.name==="node";var k={EU:{ws:"wss://krunker-editor-coop-eu.herokuapp.com",ping:"https://dynamodb.eu-west-1.amazonaws.com"},US:{ws:"wss://krunker-editor-coop-us.herokuapp.com",ping:"https://dynamodb.us-east-1.amazonaws.com"}},un=25e3*60,oo=20,A=1e3/oo,pn=60*10,no=32,ro=new RegExp(String.raw`^\w+:[a-f\d]{${no}}\$?$`),ke=new RegExp(String.raw`(?:https://krunker\.io/editor\.html\?room=)?(${ro.source.slice(1,-1)})`);var Z={[0]:5,[1]:10,[2]:20},Me=32,Ie=16,Pe=200;var De=100;var Te="#f1f1f1";var g={name:localStorage.getItem("krunker_username")||"",renderCoopOutlines:!0,playerOpacity:1,streamerMode:!1,autoChatScroll:!0,region:null};function Re(){let e=GM_getValue("settings");return e&&Object.assign(g,JSON.parse(e)),e!==void 0}function j(e,t){g[e]=t,GM_setValue("settings",JSON.stringify(g))}function M(e){return String(e).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function K(e){let t=document.createElement("span");return t.textContent=e,t.innerHTML}function Ke(e){e=K(e);let t=/(\bhttps?:\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gi;e=e.replace(t,'<a class="chatLink" href="$1" target="_blank">$1</a>');let o=/\b(\w*)::(\d+)\b/gi;return e=e.replace(o,'<a class="chatLink" href="javascript:EP.selectObjectFromSID($2)">$1::$2</a>'),e.replace(/\n/g,"<br>")}function I(e){if(!e)return history.replaceState("","",location.pathname);g.streamerMode&&(e="*".repeat(e.length),GM_setValue("lastRoomId",e)),history.replaceState("","",`${location.pathname}?room=${e}`)}function P(e){if(e||(e=KE.objectSelected(!0)),!e)return[];let t=KE.objGroups[e.uuid];return t?KE.objInsts.filter(o=>t.objects.includes(o.boundingMesh.uuid)):[]}function z(){let e=KE.objInsts;KE.objInsts=[];let{config:t}=KE.getMapExport(!0);return KE.objInsts=e,t||{}}var Ue={clearMapOnDisconnect:!0,password:"",size:Z[0]},ae=class{constructor(t,o){this.id=t;this.settings=o;this.players=[];this.messages=[];this.lastSID=0}addChatMessage(t){this.messages.push(t),this.messages.length>De&&this.messages.shift()}get host(){return this.players[0]}findPlayer(t){return this.players.find(o=>o.id===t)}};var b={};function Ge(){for(let e=0;e<300;e++)try{let t=unsafeWindow.__webpack_require__(e);"encodeNetworkMessage"in t?b.utils=t:"customGUIs"in t?b.overlay=t:"decodeStream"in t?b.msgpack=t:"hitBoxMaterial"in t&&(b.ObjectInstance=t),b[e]=t}catch(t){}if(!Object.keys(b).length)throw new Error("Webpack module loading failed");return b}var ce=class{constructor(t){this.pos=[0,0,0];this.rot=[0,0,0];var o,n,r;this.room=t.room,this.name=t.name,this.color=(o=t.color)!=null?o:"#000000",this.id=(n=t.id)!=null?n:-1,this.role=(r=t.role)!=null?r:0,this.selectObject(t.selectedSID),this.move(t.pos,t.rot)}move(t=[0,0,0],o=[0,0,0]){this.pos=[...t],this.rot=[...o]}selectObject(t){this.selectedSID=t}get isHost(){return this.id===0}};var He,V=class{constructor(t,o,n){this.name=t;this.color=o;this.object=n;KE.scene.add(n)}static create(t,o,n=[0,0,0],r=[0,0,0]){return He||(He=new KE.THREE.OBJLoader),new Promise(s=>{He.load("https://assets.krunker.io/models/spawn_0.obj",c=>{let m=new V(t,o,c);m.createLabel(),m.updateMaterial(g.playerOpacity),m.move(n,r),s(m)})})}updateMaterial(t){let o=this.object.children[0];for(let n of o.material)n.opacity=t,n.transparent=t<1,n.color.set(this.color),n.fog=!1;this.object.children[1].visible=t>0}delete(){KE.scene.remove(this.object)}move(t,o){var T,H;let{Tween:n,Easing:r}=unsafeWindow.TWEEN;(T=this.posTween)==null||T.stop(),(H=this.rotTween)==null||H.stop();let s=this.object.position,c={x:s.x,y:s.y+10,z:s.z},m={x:0,y:this.object.rotation.y,z:0};this.posTween=new n(c).to(new KE.THREE.Vector3(...t),A*3).easing(r.Sinusoidal.Out).onUpdate(()=>this.object.position.set(c.x,c.y-10,c.z)).onComplete(()=>this.posTween=void 0).start(),this.rotTween=new n(m).to({x:0,y:o[1],z:0},A*3).easing(r.Sinusoidal.Out).onUpdate(()=>this.object.rotation.set(0,m.y,0)).onComplete(()=>this.rotTween=void 0).start()}createLabel(){let t=io(this.name,this.color,80);if(!t)return;let o=new KE.THREE.CanvasTexture(t);o.magFilter=KE.THREE.NearestFilter,o.wrapS=o.wrapS=KE.THREE.ClampToEdgeWrapping;let n=new KE.THREE.SpriteMaterial({map:o,depthTest:!1,fog:!1}),r=new KE.THREE.Sprite(n);r.position.copy(this.object.position),r.position.y+=12,this.object.add(r),r.onBeforeRender=()=>{let s=new KE.THREE.Vector3;KE.camera.getWorldPosition(s);let c=this.object.position.distanceTo(s)/20,m=Math.max(4,c);r.scale.x=t.width*.003*m,r.scale.y=t.height*.003*m}}};function io(e,t,o){let n=document.createElement("canvas").getContext("2d");if(!n)return;let r=`${o}px gamefont`,s=o+120;n.canvas.height=s,n.font=r;let m=n.measureText(e).width+50;return n.canvas.width=m,n.font=r,n.textBaseline="middle",n.textAlign="center",n.fillStyle="black",n.fillText(e,m/2+5,s/2+5),n.fillStyle=t,n.fillText(e,m/2,s/2),n.canvas}var le=class extends ce{constructor(t){super(t);this.isYou=!1;this.room=t.room,t.isYou&&(this.isYou=!0),this.outlineMaterial=new KE.THREE.MeshBasicMaterial({color:this.color,side:KE.THREE.BackSide,transparent:!0,opacity:.5})}move(t,o){var n;super.move(t,o),(n=this.model)==null||n.move(t,o)}async createModel(){return this.model=await V.create(this.name,this.color,this.pos,this.rot),this.model}selectObject(t){if(super.selectObject(t),this.isYou)return;t==null&&this.removeOutline();let o=t?this.room.getObject(t):void 0;o&&this.setOutline(o)}setOutline(t){this.outlineMesh&&this.removeOutline();let o=new KE.THREE.Mesh(t.defaultMesh.geometry,this.outlineMaterial);o.userData.owner=t,o.visible=!1,this.outlineMesh=o,t.outlines||(t.outlines=[]),t.outlines.push(o),KE.scene.add(o)}removeOutline(){if(!this.outlineMesh)return;let t=this.outlineMesh.userData.owner;if(!t.outlines)return;let o=t.outlines.indexOf(this.outlineMesh);o!==-1&&t.outlines.splice(o,1),KE.scene.remove(this.outlineMesh),this.outlineMesh=void 0}};var i;function Le(e){i=e}function de(e){var o;let t=e.room.players.indexOf(e);t!==-1&&e.room.players.splice(t,1),(o=e.model)==null||o.delete(),e.removeOutline(),e.isYou&&Le(void 0)}function Ae(){let e=i==null?void 0:i.room;if(!!e)for(let t=e.players.length-1;t>=0;t--)de(e.players[t])}function X(e,t){let o=new le({room:t,id:e[0],name:e[1],color:e[2],isYou:e[3],role:e[4],pos:e[5][0],rot:e[5][1]});return o.selectObject(e[6]),o.isYou?Le(o):o.createModel(),t.players.push(o),o}function ze(e,t,o){var r;let n=(r=i)==null?void 0:r.room.findPlayer(e);n==null||n.move(t,o)}function Ve(...e){var t;for(let o of e)(t=i)==null||t.room.addChatMessage(o)}var ue=F(q());function ee(e,t,o){let n=new Set([...Object.keys(e),...Object.keys(t)]),r={};for(let s of n){let c=e[s],m=t[s];(0,ue.deepEqual)(c,m)||(r[s]=m,o&&(0,ue.deepEqual)(m,o[s])&&(r[s]=void 0))}return r}function N(e,t,o){for(let[n,r]of Object.entries(t))r==null?o?e[n]=o[n]:delete e[n]:e[n]=r}var ot=F(q());var B=F(q());var te={},oe,D={},ne=[],U=[],_=[],ge=[],$,pe,be=!1,fe=0;function $e(){D={},ne=[],U=[],_=[],ge=[],te={},oe=void 0,$=void 0,fe=0}function so(){let e=KE.objectSelected()||void 0;if(e){let t=[e.userData.owner,...P(e)];Be(t)}}function ao(){pe=setInterval(()=>{mo(),bo(),lo()},250)}function co(){pe&&clearInterval(pe)}function lo(){let e=b.utils.parseGUIs(b.overlay.customGUIs);$&&!(0,B.deepEqual)($,e)&&O(19,e),$=e}function uo(){var t;let e=ne.map(o=>({...o.serialize(),sid:o.sid}));if(e.length){let n=((t=KE.objectSelected())==null?void 0:t.userData.owner.sid)===e[e.length-1].sid;O(9,n,...e)}ne=[]}function po(){if(!i)return;let e=KE.controls.getObject().position.toArray(),t=KE.controls.getRotation();t=[t[1],t[0],0];let o=!(0,B.shallowEqual)(e,i.pos),n=!(0,B.shallowEqual)(t,i.rot);(o||n)&&(O(17,o?e:void 0,n?t:void 0),i.move(e,t))}function fo(){var o;if(!i)return;let e=(o=KE.objectSelected())==null?void 0:o.userData.owner.sid;i.selectedSID!=e&&(i.selectObject(e),(e==null||e>0)&&O(12,e))}function Be(e){let t=[];for(let o of e){let n=D[o.uuid],r=o.serialize();if(!n){D[o.uuid]=r;continue}if(o.synced){let s=ee(n,r);Object.keys(s).length&&t.push({sid:o.sid,...s}),D[o.uuid]=r}}t.length&&O(11,...t)}function mo(){let e=KE.objInsts.filter(t=>!t.partial).slice(0,200);Be(e),e.forEach(t=>t.partial=!0),e.length||KE.objInsts.forEach(t=>t.partial=!1)}function go(){let e=[];for(let t=_.length-1;t>=0;t--){let{oldPlaceholder:o,placeholder:n}=_[t];if(!n.synced||o&&!o.synced)continue;if(!KE.objGroups[n.boundingMesh.uuid]){console.warn("invalid created group",o,n),_.splice(t,1);continue}let r=P(n.boundingMesh);r.every(s=>s.synced)&&(e.push([o==null?void 0:o.sid,n.sid,...r.map(s=>s.sid)]),_.splice(t,1))}e.length&&O(13,...e)}function Ne(e,t){let o=[];for(let n=e.length-1;n>=0;n--){let r=e[n];r.synced&&(o.push(r.sid),e.splice(n,1))}o.length&&O(t,...o)}function bo(){let e={},t={};Object.keys(te).length&&(e=ee(te,KE.mapConfig,KE.defaultMapConfig));let o=z();oe&&(t=ee(oe,o)),(Object.keys(e).length||Object.keys(t).length)&&O(8,e,t),ye(),ve(o)}function We(){be=!0,$e(),ao()}function Je(){be=!1,$e(),co()}function Ye(){!be||Date.now()-fe<A||(Ne(U,10),uo(),Ne(ge,14),go(),so(),fo(),po(),fe=Date.now())}function Fe(e){!i||(e.sid=i.room.nextSid(),ne.push(e))}function Ze(e){delete D[e.uuid],U.push(e)}function he(e,t){if(t){let o=U.indexOf(t);o!==-1&&U.splice(o,1)}_.push({oldPlaceholder:t,placeholder:e})}function Xe(e){ge.push(e),delete D[e.uuid],P(e.boundingMesh).forEach(o=>delete D[o.uuid])}function Qe(e){$=e}function et(e,t){D[e]=t}function ye(){te={...KE.mapConfig}}function ve(e){oe=e!=null?e:z()}function tt(e,t){let o=U.find(n=>n.sid===e);o&&(o.sid=t)}var nt={objectAdded:!0,objectRemoved:!0,allowHideTransform:!0,createGroup:!0,removeGroup:!0,clearMap:!0},x={...nt},R=!1;function rt(){ho(),ko(),jo(),Co(),So(),Mo(),wo(),xo(),Oo(),vo(),yo(),Eo()}function S(e,t){let o=x;x={...nt,...t},e(),x=o}function G(e){R=e}function ho(){let{ObjectInstance:e}=b;Object.assign(unsafeWindow,{ObjectInstance:e}),e.hitBoxMaterial.color.set(4991687),e.prototype.partial=!1,Object.defineProperty(e.prototype,"synced",{get(){return this.sid>0}});let{serialize:t}=e.prototype;e.prototype.serialize=function(...n){let r=t.apply(this,n);return this.rot.some(s=>s)&&(r.r=this.rot.map(s=>s.round(4))),this.texOffX>0&&(r.tox=this.texOffX.round(4)),this.texOffY>0&&(r.toy=this.texOffY.round(4)),r};let{deserialize:o}=e;e.deserialize=n=>{let r=o(n);return r.sid=typeof n.sid=="number"?n.sid:0,r}}function yo(){let e=KE.removeGroup.bind(KE);KE.removeGroup=t=>{R&&x.removeGroup&&(t||(t=KE.objectSelected(!0)),t&&Xe(t.userData.owner)),S(()=>e(t),{objectRemoved:!1})}}function vo(){let e=KE.createGroup.bind(KE);KE.createGroup=(...t)=>{var o,n;if(e(...t),R&&x.createGroup){let r=(o=KE.objectSelected(!0))==null?void 0:o.userData.owner,s=(n=t[0])==null?void 0:n.userData.owner;r&&he(r,s)}}}function Eo(){let e=KE.duplicateGroup.bind(KE);KE.duplicateGroup=t=>{var o;if(S(()=>e(t),{createGroup:!1}),R&&x.createGroup){let n=(o=KE.objectSelected(!0))==null?void 0:o.userData.owner;n&&he(n)}}}function Oo(){let e=KE.updateGroups.bind(KE);KE.updateGroups=()=>{e(),Ye()}}function So(){let e=KE.hideTransform.bind(KE);KE.hideTransform=()=>{if(!R||x.allowHideTransform)return e()}}function xo(){KE.on("objectRemoved",e=>{var t,o;(t=e.outlines)==null||t.forEach(n=>KE.scene.remove(n)),R&&x.objectRemoved&&Ze(e),(o=i)==null||o.room.deleteSID(e.sid)})}function wo(){KE.on("objectAdded",e=>{var t;R&&x.objectAdded&&KE.objInsts.includes(e)&&Fe(e),(t=i)==null||t.room.setSID(e)})}function jo(){let e=KE.clearMap.bind(KE);KE.clearMap=()=>{x.clearMap&&e()}}function Co(){let e=KE.testMap.bind(KE);KE.testMap=t=>{let o=KE.getMapExport.bind(KE);KE.getMapExport=()=>{let n=o();if(t)return i?M(n):n;let r=JSON.parse(n);return r.name=K(r.name),r.welMsg&&(r.welMsg=K(r.welMsg)),JSON.stringify(r)},e(t),KE.getMapExport=o}}function ko(){KE.disableHistory(),KE.initHistory=()=>{KE.historyInterval=setInterval(()=>{if(!(KE.settings.disableHistory||KE.settings.historyLimit<=0))for(let e of KE.objInsts){let t=KE.objHistory[e.uuid],o=e.serialize();t&&!(0,ot.deepEqual)(t,o)&&KE.addToHistory("update",e,KE.objHistory[e.uuid]),KE.objHistory[e.uuid]=o}},2e3)},KE.initHistory()}function Mo(){let{ObjectInstance:e}=b,t=e.prototype.update;e.prototype.update=function(o){var n;t.call(this,o),(n=this.outlines)==null||n.forEach(r=>{if(r.visible=g.renderCoopOutlines,!g.renderCoopOutlines)return;let s=r.material;s.userData.t=(s.userData.t||0)+o/100,s.opacity=.7+.3*Math.sin(s.userData.t),r.geometry=this.defaultMesh.geometry,r.position.set(0,this.boundingMesh.scale.y/2,0),r.position.applyQuaternion(this.boundingMesh.quaternion),r.position.add(this.boundingMesh.position),r.quaternion.copy(this.boundingMesh.quaternion),r.rotation.copy(this.boundingMesh.rotation);let c=this.size.map(m=>1+1/m);r.scale.fromArray(c)})}}function it(e,t){let o={objects:[]},n=Object.keys(e).length>0,r=Object.keys(t).length>0;if(n&&(N(KE.mapConfig,e,KE.defaultMapConfig),Object.assign(o,KE.mapConfig),ye()),r){o.config=z(),N(o.config,t),ve(o.config);for(let s of Object.keys(KE.serverConfig))KE.serverConfig[s]={};GUI.panel.state.refresh("panel_left_essential")}S(()=>KE.importMap(JSON.stringify(o)),{clearMap:!1})}function st(e){var o;let t=(o=i)==null?void 0:o.room.findPlayer(e);t&&(de(t),t.isHost&&alert("Host ended room"),windows[100].generatePlayers())}function at(...e){!i||e.forEach(Io)}function Io(e){if(!i)return;let t=e.shift(),o=e.shift(),n=i.room.getObject(o);if(!n)return;let r=t?i.room.getObject(t):void 0,s=KE.objInsts.filter(c=>e.includes(c.sid));s.length!==e.length&&console.warn("different group children length",e,s),r&&Do(r),i.selectedSID!=null&&i.selectedSID===t&&KE.attachTransform(n),Po(n,s),!!r&&i.room.players.filter(c=>r.sid===c.selectedSID).forEach(c=>c.selectObject(n.sid))}function Po(e,t){KE.objGroups[e.boundingMesh.uuid]={owner:e.boundingMesh,pos:e.boundingMesh.position.clone(),scale:e.boundingMesh.scale.clone(),rotY:e.boundingMesh.rotation.y,objects:t.map(o=>o.boundingMesh.uuid)}}function Do(e){S(()=>KE.removeObject(e,!0),{removeGroup:!1,objectRemoved:!1,allowHideTransform:!1})}function ct(...e){var o;if(!i)return;let t=(o=KE.objectSelected())==null?void 0:o.userData.owner.sid;for(let n of e){let r=i.room.getObject(n);if(!r)continue;let s=P(r.boundingMesh),c=t===n||s.some(m=>m.sid===t);S(()=>KE.removeGroup(r.boundingMesh),{removeGroup:!1,objectRemoved:!1,allowHideTransform:c})}}function lt(e){b.overlay.customGUIs=b.utils.parseGUIs(e,!0),Qe(e),GUI.panel.state.refresh("panel_right_gui")}function dt(...e){S(()=>e.forEach(To),{objectAdded:!1})}function To(e){let t=b.ObjectInstance.deserialize(e);KE.addObject(t,!0,!1),t.uuid=t.boundingMesh.uuid=t.sid+""}function ut(e,t){var n;let o=(n=i)==null?void 0:n.room.findPlayer(e);o==null||o.selectObject(t!=null?t:void 0)}function pt(...e){var o;if(!i)return;let t=(o=KE.objectSelected())==null?void 0:o.userData.owner.sid;for(let n of e){let r=i.room.getObject(n);if(!r)continue;let s=t===n;S(()=>KE.removeObject(r,!s,!1),{objectRemoved:!1}),delete KE.objGroups[r.boundingMesh.uuid]}}var ft=F(q());var Ro=["openEnded","team","texStretch","frameCount","bakeAcc","fullcone","faces","weaponId","poster","cmpSpwn","teamOnly","tilesX","tilesZ"],Ko=["mSize","mYOff","mROff","itemID","assetID"];function mt(...e){if(!!i)for(let t of e){let o=i.room.getObject(t.sid);o&&_o(o,t)}}function _o(e,t){var r;delete t.sid,Go(e,t),Ho(e);let o=e.serialize();if(Object.keys(t).length){N(o,t);let s=b.ObjectInstance.deserialize({...o});for(let c of KE.configVal)try{e[c]=s[c]}catch(m){}Uo(e,s)}((r=KE.objectSelected())==null?void 0:r.userData.owner.sid)===e.sid&&KE.updateObjConfigGUI(),KE.settings.disableHistory||(KE.objHistory[e.uuid]=o),et(e.uuid,o)}function Uo(e,t){try{e.regen(!0)}catch(o){}try{Ro.some(o=>!(0,ft.deepEqual)(e[o],t[o]))&&e.regen()}catch(o){}try{Ko.some(o=>typeof t[o]=="number"&&e[o].round(4)!==t[o].round(4))&&e.regenM()}catch(o){}}function Go(e,t){t.p&&(e.boundingMesh.position.fromArray(t.p),delete t.p),t.r&&(e.boundingMesh.rotation.fromArray(t.r),delete t.r),t.s&&(e.boundingMesh.scale.fromArray(t.s),delete t.s)}function Ho(e){let t=e.boundingMesh,o=KE.objGroups[t.uuid];!o||(o.pos=t.position.clone(),o.scale=t.scale.clone(),o.rotY=t.rotation.clone().reorder("YXZ").y)}function gt(...e){!i||(X(e,i.room),windows[100].generatePlayers())}function bt(){G(!1),KE.clearMap()}var Ee=class extends ae{constructor(t,o){super(t,o);this.sidHashmap={}}addChatMessage(t){super.addChatMessage(t);let o=document.getElementById("chat-list"),n=o.scrollHeight-o.scrollTop-o.clientHeight,r=document.createElement("div");r.className="chat-item";for(let s of t){let c=document.createElement("span");c.innerHTML=Ke(s[0]),c.style.color=s[1]||Te,r.appendChild(c)}o.appendChild(r),(n<100||g.autoChatScroll)&&r.scrollIntoView()}nextSid(){return--this.lastSID}getObject(t){return this.sidHashmap[t]}setSID(t,o){o!=null&&(t.sid=o),this.sidHashmap[t.sid]=t}deleteSID(t){delete this.sidHashmap[t]}};function ht(e,t,o,n){var s;let r=new Ee(e,n);o&&Lo(o),KE.objInsts.forEach(c=>r.setSID(c)),t.forEach(c=>X(c,r)),((s=i)==null?void 0:s.isHost)?KE.copyToClipboard(`https://krunker.io/editor.html?room=${r.id}`):KE.controls.getObject().position.fromArray(r.host.pos),Ao(),closeWindow(),We(),G(!0)}function Lo(e){e.map.objects.forEach(t=>{var o;return t.meshUUID=(o=t.sid)==null?void 0:o.toString()}),S(()=>KE.importMap(JSON.stringify(e)),{objectAdded:!1})}function Ao(){if(!i)return;let e=document.querySelector("#multiplayerIcon");e.style=`color: ${i.color} !important`,windows[100].generatePlayers(),I(i.room.id);let t=document.querySelector("#chat-container");t.style.visibility="visible";let o=document.querySelector("#chat-list");o.textContent=""}function yt(e){alert(e)}function vt(e){var n,r;if(!i)return;let t=i.room,o=(n=KE.objectSelected())==null?void 0:n.userData.owner.sid;for(let s=0;s<e.length;s+=2){let[c,m]=[e[s],e[s+1]],T=t.getObject(c);if(!T){tt(c,m);continue}t.deleteSID(c),t.setSID(T,m),o===c&&((r=i)==null||r.selectObject(m))}}function Et(e,t){GM_setValue(e,t)}var Oe=new Map([[3,ht],[6,gt],[17,ze],[4,Ve],[2,st],[7,yt],[5,vt],[9,dt],[10,pt],[11,mt],[12,ut],[13,at],[14,ct],[8,it],[19,lt],[16,bt],[18,Et]]);function Ot(e){try{let[t,...o]=b.msgpack.decode(new Uint8Array(e)),n=Oe.get(t);n?n(...o):console.warn("received unregistered event",t)}catch(t){console.error("event handling error",t)}}var y;async function Se(e){var t;if((y==null?void 0:y.readyState)===WebSocket.CONNECTING)throw new Error("already connecting");return(t=document.querySelector(".spinner"))==null||t.setAttribute("style",""),y=zo(k[e].ws),y.addEventListener("open",()=>console.debug("Connected")),y.addEventListener("error",()=>alert("Connection error")),y.addEventListener("close",Vo),y.addEventListener("message",({data:o})=>Ot(o)),new Promise((o,n)=>{Oe.set(15,o),y.addEventListener("close",n)})}function re(){return new Promise(e=>{if(!y)return e();y.addEventListener("close",()=>e()),y.close()})}function O(e,...t){(y==null?void 0:y.readyState)===WebSocket.OPEN&&y.send(b.msgpack.encode([e,...t]))}function zo(e){let t=GM_getValue("token",""),o=g.name,n=new URLSearchParams({version:"4.14.1"});return o&&n.set("name",o),t&&n.set("token",t),y=new WebSocket(`${e}?${n.toString()}`),y.binaryType="arraybuffer",y}function Vo(e){var o,n;e.reason&&alert(e.reason),console.debug("Disconnected"),y=void 0,Je(),G(!1),i&&I(),windows[100].generatePlayers(),(o=document.querySelector("#multiplayerIcon"))==null||o.setAttribute("style",""),(n=document.querySelector(".spinner"))==null||n.setAttribute("style","visibility: hidden");let t=document.querySelector("#chat-container");t.style.visibility="hidden",!!i&&(!i.isHost&&i.room.settings.clearMapOnDisconnect&&KE.clearMap(),Ae())}var xe={shading:{name:"Toggle Shading",object:{val:"Shift + B"},keyCode:"B",key:"val",type:"key",action:()=>KE.toggleProp("ambient")},createcube:{name:"Create Cube",object:{val:"C"},keyCode:"c",key:"val",type:"key",action:()=>ie(0)},creategate:{name:"Create Gate",object:{val:"G"},keyCode:"g",key:"val",type:"key",args:[[],!0],action:()=>ie(24),onChange:console.log},createtrigger:{name:"Create Trigger",object:{val:"R"},keyCode:"r",key:"val",type:"key",action:()=>ie(29)},createteleporter:{name:"Create Teleporter",object:{val:"T"},keyCode:"t",key:"val",type:"key",action:()=>ie(27)},players:{name:"Open Player List",object:{val:"Tab"},keyCode:"Tab",key:"val",type:"key",action:()=>showWindow(101)},chat:{name:"Chat",object:{val:"Enter"},keyCode:"Enter",key:"val",type:"key",action:()=>{var e;return(e=document.querySelector("#chat-input"))==null?void 0:e.focus()}}};function ie(e){KE.addObject(b.ObjectInstance.defaultFromType(e,KE.getNearPosition()))}function St(){addEventListener("keydown",e=>{if(KE.isTyping(e)||!KE.enabled||e.ctrlKey)return;let t=Object.values(xe).find(({keyCode:o})=>o===e.key);!t||(t.action(),e.preventDefault(),e.stopImmediatePropagation())})}var C;function Ct(){document.body.oncontextmenu=null,KE.renderer.domElement.oncontextmenu=()=>!1,Promise.resolve().then(()=>jt()),$o(),No(),qo(),Yo(),Jo(),Fo(),Wo(),Bo()}function kt(){document.title+="+";let e=document.querySelector('link[rel~="icon"]'),t=e.cloneNode(!0);e.href=t.href="https://i.imgur.com/WdYKPAE.png",document.head.appendChild(t)}function qo(){var o;C=document.createElement("div"),C.classList.add("joinPop"),(o=document.querySelector("#popupHolder"))==null||o.appendChild(C);let e=unsafeWindow.resetPops;unsafeWindow.resetPops=()=>{e(),C.style.display="none"};let t=unsafeWindow.clearPops;unsafeWindow.clearPops=()=>{t(),C.style.display="none"}}function Mt(){unsafeWindow.resetPops(),C.style.display="block",C.innerHTML=`<div class='popupTitle'>Join Room</div>
  <input id='roomId' class='joinInput' type='text' placeholder='Link or room ID' autofocus>
  <button id='joinPopupBtn' class='primary joinBtn' onclick='clearPops()'>Join</button>`;let e=document.querySelector("#joinPopupBtn");e.onclick=()=>{let t=document.querySelector("#roomId").value;I(we(t)),location.reload()}}function It(){unsafeWindow.resetPops(),C.style.display="block",C.innerHTML=`<div class='popupTitle'>Join Room</div>
  <input id='joinPassword' class='joinInput' type='password' placeholder='Enter Password' autofocus>
  <button id='joinPopupBtn' class='primary joinBtn' onclick='clearPops()'>Join</button>`;let e=document.querySelector("#joinPopupBtn");e.onclick=se}function No(){let e=GUI._html.input.fixed.vector3.bind(GUI);GUI._html.input.fixed.vector3=(...t)=>e(...t).replace(/ type="number"/g,' type="text"'),GUI.update.number.change=t=>{let o=0;try{o=Function(`"use strict";return (${t.value})`)()}catch(n){}t.value=(Number.isFinite(o)?o:0).toString()},GUI._html.input.resizable.password=(t,o,n)=>`<input class="inlineInput" type="password" placeholder="${M(n)}" value="${M(t)}" oninput="${M(o)}" maxlength="${Me}" onchange="GUI.update.field(this)">`}function $o(){document.querySelector("#playbar").innerHTML+=`<div class="playbarItemR" onclick="showWindow(100)" title="Multiplayer Editing">
  <i id="multiplayerIcon" class="material-icons">group_add</i>
</div>`;let e=document.querySelector("#versionTxt");e.innerHTML=`<span id="epVersion" title="Click To Update Editor+

  By Jakob#8686">Editor+ v4.14.1</span> | ${e.innerHTML}`,e.addEventListener("click",()=>{GM_setValue("lastModified",0),location.reload()})}function Bo(){windows[100]={header:"Player List",width:"600px",getPlayerCount(){var e,t;return`[${((e=i)==null?void 0:e.room.players.length)||0}/${((t=i)==null?void 0:t.room.settings.size)||0}]`},generatePlayers(){if(!i)return"";let e=i.room.players.map(n=>{var r;return`
<div class='section' style='font-size:25px'>
${n.isHost?'<i class="material-icons">stars</i>':""}
<span style='color:${n.color}'>${K(n.name)}</span>

${n.isYou?"":`
<div class='searchBtn' title='Teleport' style='float:right; width: initial; margin-top: 0px' onclick='closeWindow();EP.tpToPlayer(${n.id})'><i class='material-icons' style='color: #202020; font-size: 25px'>explore</i></div>
<div class='searchBtn' title='Select object' style='float:right; width: initial;  margin-top: 0px' onclick='closeWindow();EP.selectObjectOfPlayer(${n.id})'><i class='material-icons' style='color: #202020; font-size: 25px'>view_in_ar</i></div>
`}

${((r=i)==null?void 0:r.isHost)&&!n.isYou?`
<div class='searchBtn' title='Kick' style='float:right; width: initial; margin-top: 0px' onclick='closeWindow();EP.punish(${n.id}, "kick")'><i class='material-icons' style='color: #202020; font-size: 25px'>person_remove</i></div>
<div class='searchBtn' title='Ban' style='float:right; width: initial; margin-top: 0px' onclick='closeWindow();EP.punish(${n.id}, "ban")'><i class='material-icons' style='color: #202020; font-size: 25px'>person_off</i></div>`:""}
</div>`}).join(""),t=document.querySelector("#playerList");t&&(t.innerHTML=e);let o=document.querySelector("#playerCount");return o&&(o.textContent=this.getPlayerCount()),e},gen(){return`<div class='windowHeader'>
      <div>Player List</div>
      <div id='playerCount' style='float:right;'>${this.getPlayerCount()}</div>
  </div>
  <div class='windowBody'>
      <span id='playerList'>${this.generatePlayers()}</span>
  </div>`}}}function Wo(){var o;let e=document.createElement("div");e.id="chat-container",e.innerHTML=`<div id='chat-list'></div>
<input id='chat-input' class='inlineInput' type='text' placeholder='Enter Message' maxlength='${Pe}' autocomplete='off'>`,(o=document.querySelector("#center"))==null||o.appendChild(e),document.querySelector("#chat-input").addEventListener("keydown",n=>{n.key==="Enter"&&je()})}function Jo(){windows[2].tabNames.push("Editor+"),GUI._window.settings["editor+"]={gen(){return GUI._window.settings["editor+"].blueprint={name:{name:"Multiplayer Name",object:g,key:"name",type:"text",onChange(e,t){j("name",t.slice(0,Ie))}},autoChatScroll:{name:"Auto Chat Scroll",object:g,key:"autoChatScroll",type:"switch",onChange(e,t){j("autoChatScroll",t)}},renderCoopOutlines:{name:"Render Selected Object Outline",object:g,key:"renderCoopOutlines",type:"switch",onChange(e,t){j("renderCoopOutlines",t)}},streamerMode:{name:"Streamer Mode (hide room ID)",object:g,key:"streamerMode",type:"switch",onChange(e,t){j("streamerMode",t)}},playerOpacity:{name:"Player Opacity",object:g,key:"playerOpacity",type:"slider",args:[0,1,.1],onChange(e,t){var o;j("playerOpacity",t.round(1)),(o=i)==null||o.room.players.forEach(n=>{var r;return(r=n.model)==null?void 0:r.updateMaterial(t)})}}},GUI._build(["_window","settings","editor+","blueprint"])}}}function Yo(){windows[0].tabNames.push("Editor+"),GUI._window.controls["editor+"]={gen(){return GUI._window.controls["editor+"].blueprint=xe,GUI._build(["_window","controls","editor+","blueprint"])}}}function Fo(){let t=GM_getValue("token")?1:null,o=Z[t||0];GUI.roomSettings={settings:{...Ue},gen(){return GUI.roomSettings.blueprint={rule:{type:"rule"},players:{name:"Players",object:this.settings,key:"size",type:"slider",args:[1,o,1]},password:{name:"Room Password",object:this.settings,key:"password",type:"password",args:["Enter Password"]},serverRegion:{name:"Server Region",object:g,key:"region",type:"select",args:[Object.keys(k).map(n=>({name:n,value:n}))],onChange(n,r){j("region",r)}},clearMapOnDisconnect:{name:"Clear map on disconnect",object:this.settings,key:"clearMapOnDisconnect",type:"switch"},rule2:{type:"rule"}},GUI._build(["roomSettings","blueprint"])}},windows[99]={header:"Multiplayer editing",width:"600px",gen:()=>`<div class="spinner" style="visibility: hidden">
    <div class="bounce1"></div>
    <div class="bounce2"></div>
    <div class="bounce3"></div>
</div>
<div class="windowHeader" style="text-align: center;">
    <div>Multiplayer Editing</div>
</div>
<div class="windowBody">
    <div class="warning section">Only invite people you completely trust<br>
        they have full control over the map and can steal it or mess it up</div>
    ${GUI.roomSettings.gen()}
    <div class="section button-row">
        <button id="inviteBtn" class="primary" onclick="EP.copyRoomURL() || EP.host()">Invite</button>
        <button class="primary" onclick="EP.joinPrompt()">Join</button>
        <button class="secondary" onclick="EP.disconnect()">Disconnect</button>
    </div>
</div>`}}var Zo={disconnect:re,host:tn,join:Pt,joinPrompt:en,copyRoomURL:Xo,sendChat:je,punish:rn,tpToPlayer:on,selectObjectOfPlayer:nn,selectObjectFromSID:Dt,quoteAttribute:M,settings:g};Object.assign(unsafeWindow,{EP:Zo});function Xo(){return i?(KE.copyToClipboard(`https://krunker.io/editor.html?room=${i.room.id}`),document.querySelector("#inviteBtn").textContent="Copied",!0):!1}function we(e){let t=e.match(ke);return t==null?void 0:t[1]}async function Qo(){try{let e=await navigator.clipboard.readText();return we(e)}catch(e){console.error(e)}}async function en(){let e=await Qo();if(e){I(e),location.reload();return}Mt()}async function Pt(e,t){let o=e.split(":")[0];await re(),await Se(o),O(1,e,t)}function se(){var o;let e=new URLSearchParams(location.search).get("room");if(e&&/^\*+$/.test(e)&&(e=GM_getValue("lastRoomId")),!e)return;let t=(o=document.querySelector("#joinPassword"))==null?void 0:o.value;if(e.endsWith("$")&&!t)return It();Pt(e,t)}async function tn(){await re(),await Se(g.region||Object.keys(k)[0]),KE.objInsts.forEach((t,o)=>t.sid=o+1);let e=sn();O(0,e,GUI.roomSettings.settings)}function on(e){var o;let t=(o=i)==null?void 0:o.room.findPlayer(e);!t||KE.controls.getObject().position.fromArray(t.pos)}function nn(e){var o;let t=(o=i)==null?void 0:o.room.findPlayer(e);(t==null?void 0:t.selectedSID)!=null?Dt(t.selectedSID):KE.hideTransform()}function Dt(e){var o;let t=(o=i)==null?void 0:o.room.getObject(e);t&&KE.attachTransform(t)}function rn(e,t){O(16,e,t)}function sn(){let e=KE.save(!0);for(let t of e.map.objects)delete t.meshUUID,delete t.objUUID;delete e.history,delete e.selected,e.groups={};for(let t of Object.keys(KE.objGroups)){let o=KE.objGroups[t].owner,n=P(o).map(r=>String(r.sid));e.groups[o.userData.owner.sid]={ids:n}}return e}function je(){var n;let e=document.querySelector("#chat-input"),t=e.value,o=(n=KE.objectSelected())==null?void 0:n.userData.owner;if(o){let r=o.objType.toLowerCase();t=t.replace(/@obj/gim,`${r}::${o.sid}`)}t.length&&(O(4,t),e.value=""),e.blur()}async function Tt(){let e=[];for(let[t,o]of Object.entries(k)){await fetch(o.ping);let n=Date.now();await fetch(o.ping),e.push({region:t,ms:Date.now()-n})}return e.reduce((t,o)=>o.ms<t.ms?o:t)}var an=Re();g.region||Tt().then(({region:e})=>j("region",e));Object.assign(unsafeWindow,{patchModules(){let{utils:e}=Ge(),{removePrivateKeys:t}=e;e.removePrivateKeys=o=>o._html?o:t(o)}});addEventListener("editor-plus-init",e=>{let t=e.detail.replace(/=(.{1,10}?)\([^)]{1,5}\).{1,4}init.{1,4}editor.{1,4};/,"$&window.__webpack_require__=$1;patchModules();").replace(/\[(["']text["'],["']select-one["']\])/,'["password",$1').replace(/(?<=value=.{1,5}[+$]).+?(?=[+}])/g,"EP.quoteAttribute($&)");new Function(t)()});function cn(){an&&KE.setSettings("degToRad","true"),KE.connected||KE.initConnection(),St(),rt(),Ct(),kt(),se(),console.debug("Editor+ loaded")}var Rt;Object.defineProperty(unsafeWindow,"KE",{get:()=>Rt,set(e){Rt=e,cn()}});})();
